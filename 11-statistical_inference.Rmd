

## Estimation and confidence interval 

앞서 예제에서 두 그룹간 평균의 차이가 통계량 (statistic) 입니다. 통계량은 모수 (parameter)를 추정하기 위한 값으로 볼 수 있고 이 값이 얼마나 모수와 가까운지, 즉 차이가 0에 가까운지 판단하는 것은 통계적 추정에서 가장 중요한 부분 중 하나 입니다. 일반적으로 $\mu, \sigma$ 등 모수는 $\theta$로 표현하고 $\theta$를 추정하기위한 통계량은 $\hat{\theta}$로 표현합니다. 다음 식으로 우리가 계산한 통계량이 얼마나 모수에 가까운지는 다음 식으로 알 수 있습니다. 

$$
E((\hat{\theta} - \theta)^2) = VAR(\hat{\theta}) + (E(\hat{\theta}-\theta))^2 = \text{variance} + \text{bias}^2
$$
우리가 언급하는 통계량들은 대부분 unbiased 입니다. 불편추정량 (unbiased estimator)이라 부르며 다음과 같은 것들이 있습니다. 

* $E(\bar{x}) = \mu$
* $E(\bar{p}) = p$
* $E(s^2) = \sigma^2$

예를 들어 A poll asking a random sample of 1003 whether marriages between same-sex couples should be recognized by law as valid. 55% said yes, 이 경우 A randomly selected person would responding yes with $\hat{p}$  = 0.55 입니다. 

여기서 이러한 투표를 100번 반복 했을 때 계산되는 찬성 비율 값들이 대부분 (또는 95%는) 어디에 모여 있는가? 라는 질문을 할 수 있고 이는 모집단에서의 찬성 비율 (모수, 진짜) 값의 95% 신뢰구간은 무엇인가? 라는 질문과 같습니다. 이를 위해 다음 시뮬레이션을 수행할 수 있습니다. 

```{r, eval=F, echo=T}

p <- 0.55
n <- 1003
x <- rbinom(1000, n, p)
#mean(x)
hist(x, br=100)
quantile(x, c(0.025, 0.975))

```

앞 뒤 0.025%를 제외한 구간은 위와 같으며 위 구간이  95% 신뢰구간이 됩니다. 뒤에서 설명이 나오지만 여기서 신뢰구간의 해석을 한 번 생각해 보면 좋습니다. 

그런데 현실에서는 1000번의 반복이 불가능하며 1번 또는 2번의 데이터로 95% 신뢰구간을 구해야 합니다. 즉, 위 예제에서 1003명에 대한 설문조사로 $\hat{p}=0.55$ 가 나왔다는 정보 하나만으로 신뢰구간을 추정해야 하는 것 입니다. 

여기서 다시 기억할 부분은 앞에서 배운 확률변수 표본평균의 표본 분포는 정규분포이며 그 표준편차는 모표준편차를 $\sqrt{n}$으로 나누어준 값이라는 것 입니다. (후에 좀 더 학습할 예정이며 지금은 시뮬레이션으로 얼마든지 반복해서 샘플링이 가능한 것으로 생각하겠습니다) 결국 데이터는 하나뿐이지만 분포를 정규분포로 알고 있으므로 신뢰구간도 구할 수 있는 것 입니다. 좀 더 명확한 분포를 정보를 위해 표준정규분포로 전환하며 표준정규분포를 따르는 z-통계량은 다음과 같이 나타낼 수 있습니다.


$$
\hat{p} = p \to \hat{p} - p =0 \\
z = \frac{\hat{p} - p}{SD(\hat{p})} \sim N(0,1) 
$$



그런데 $SD(\hat{p})=\sigma/\sqrt{n}$는 알 수 없으므로 중심극한정리에 의해 $n$이 충분히 클 경우 $SD(\hat{p})$의 모표준편차 $\sigma$를 샘플의 표준편차로 대체한 표준오차 $SE(\hat{p})=s/\sqrt{n}$를 사용합니다. 베르누이 분포에서 샘플의 표준편차$s$는 $\sqrt{\hat{p}(1-\hat{p})}$ 이므로 $SE(\hat{p})=\sqrt{\frac{\hat{p}(1-\hat{p})}{n}}$ 입니다. 


이제 위 투표 예제의 $\hat{p}=0.55$와 $n=1003$을 위 z값 공식에 대입해 봅니다. 

$$
z = \frac{0.55 - p}{0.0157} 
$$

그런데 $p$값은 우리가 관심있는 모수이고 z 값은 표준정규분포 이므로 아래 z 값의 특정 범위를 지정할 수 있습니다. 결국 $p$ 값만 남기고 모든 항을 넘기면 $p$값의 범위를 구할 수 있습니다. 후에 이러한 방법으로 신뢰구간을 구하는 방법을 알아봅니다. 


모평균에 대한 신뢰구간도 유사한 방법으로 구할 수 있습니다. 평균 100, 표준편차 16인 모분포에서 4개의 샘플을 랜덤하게 추출하여 그 평균을 구하는 시뮬레이션을 수행합니다. 확률변수 평균의 $\bar{x}$ 분포는 정규분포를 따르고 표준화 값인 z값은 표준정규분포 N(0, 1)을 따릅니다. 다음과 같은 시뮬레이션으로 확인할 수 있으며 95% 신뢰구간도 ```quantile```함수를 이용해서 구할 수 있습니다. 

```{r, eval=F, echo=T}

mu <- 100
sigma <- 16
M <- 1000
n <- 4
res <- replicate(M, {
	x <- rnorm(n, mu, sigma)
	se <- sd(x)/sqrt(n)
	(mean(x) - mu)/se
})

quantile(res, c(0.025, 0.975))
hist(res, br=100)
```


```{r, eval=F, echo=F}

ggplot(data.frame(res), aes(x=res)) + 
  geom_histogram()

```
 

시뮬레이션을 사용할 수 없는 일반적인 경우 신뢰구간을 구하는 방법을 알아봅니다. 다음과 같이 $\mu$를 모평균, $\bar{x}$를 확률변수 t-통계량은 $\sigma$ 대신 $s$를 사용한 경우를 말합니다.  
 
\begin{split}
\bar{x} &= \mu \to \bar{x} - \mu =0 \\

z &= \frac{\bar{x} - \mu}{\sigma / \sqrt{n}} \sim N(0,1) \\

t &= \frac{\bar{x} - \mu}{s/\sqrt{n}} \sim T
\end{split}




참고로 다음은 오차 (error), 편차/잔차 (deviance/residual), 그리고 편향 (bias) 에대한 개념을 나타냅니다. 

![](images/08/03.PNG)


이제 확률변수 평균 $\bar{x}$의 95% 신뢰구간을 구해봅니다. 이는 앞서 언급한바와 같이 샘플링 후 평균을 구하는 과정을 계속 반복할 경우 데이터의 95% 가 어디 있는가에 대한 질문과 같으며 이는 위와 같은 대칭형 표준정규분포에서 왼쪽 0.025% 와 오른쪽 0.025%를 제외한 가운데 부분의 데이터를 말합니다. 

$$
\begin{split}
-3.33 <  \frac{\bar{x} - \mu}{s/\sqrt{n}} < 3.07 \\
\bar{x} -3.33 \times s/\sqrt{n}  < \mu &< \bar{x} + 3.07 \times s/\sqrt{4}  
\end{split}
$$


![](images/08/04.PNG)



## Bootstrap 

분포를 모를 경우 분포를 생성하는 방법으로 적당한 수의 샘플 수가 있을 경우에 가능한 방법입니다. UsingR 패키지의 Dedicare 데이터셋을 예로 들면, 병원비 청구 금액과 지불금액의 차이가 큰 범위의 분포를 가지고 있는 상황이며 합리적인 (?) 신뢰구간을 구하는 문제입니다. 





```{r, eval=F}
suppressWarnings(suppressMessages(library(UsingR, quietly = T)))
suppressWarnings(suppressMessages(library(ggplot2)))
diabetes <- subset(Medicare, subset= DRG.Definition =="638 - DIABETES W CC")
gap <- with(diabetes, Average.Covered.Charges-Average.Total.Payments)
ggplot(data.frame(gap), aes(x=gap)) + geom_histogram(bins=30)
```

```sample``` 함수 복원 추출 허용 분포를 생성합니다.  

```{r eval=F}
M <- 2000
res <- replicate(M, {
  xstar <- sample(gap, length(gap), replace=T)
  mean(xstar) - xbar
})
conf95 <- quantile(res, c(0.025, 0.975))
ggplot(data.frame(res), aes(x=res)) + 
  geom_histogram(bins=30) +
  geom_vline(xintercept=conf95, linetype="dashed", color='blue', size=1.2) +
  geom_label(aes(x=conf95[1], y=400, label=round(conf95[1]))) +
  geom_label(aes(x=conf95[2], y=400, label=round(conf95[2])))
```

## interpretation of confidence interval 

![](images/08/07.PNG)


